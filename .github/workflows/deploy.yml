# ğŸš€ CI/CD Pipeline - LucresIA Elevare
# Dispara deploy automÃ¡tico no Railway quando hÃ¡ push na main

name: Deploy to Railway

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # ğŸ” LINT & TYPE CHECK
  # ============================================
  quality:
    name: ğŸ” Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Type Check
        run: pnpm exec tsc --noEmit
        continue-on-error: true

  # ============================================
  # ğŸ—ï¸ BUILD
  # ============================================
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build
        run: pnpm build

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  # ============================================
  # ğŸš€ DEPLOY TO RAILWAY
  # ============================================
  deploy:
    name: ğŸš€ Deploy to Railway
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸš‚ Deploy to Railway
        uses: bervProject/railway-deploy@main
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: ${{ secrets.RAILWAY_SERVICE_ID }}

  # ============================================
  # ğŸ“Š NOTIFY (opcional)
  # ============================================
  notify:
    name: ğŸ“Š Notify Success
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    steps:
      - name: âœ… Deploy Successful
        run: |
          echo "ğŸ‰ Deploy concluÃ­do com sucesso!"
          echo "ğŸŒ URL: https://acceptable-elegance-production-0f9f.up.railway.app"
          echo "ğŸ“… Data: $(date)"
