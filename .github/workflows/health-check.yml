name: Production Health Check

on:
  schedule:
    # Executa a cada 5 minutos
    - cron: '*/5 * * * *'
  workflow_dispatch: # Permite execu√ß√£o manual

env:
  PRODUCTION_URL: "https://acceptable-elegance-production-0f9f.up.railway.app"

jobs:
  check-health:
    name: Verificar Sa√∫de da Produ√ß√£o
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Testar Health Check Endpoint
        id: health
        run: |
          # URL de produ√ß√£o do Railway
          PROD_URL="${{ env.PRODUCTION_URL }}"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" $PROD_URL/api/trpc/health.check || echo "000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response=$BODY" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Health check falhou! HTTP $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi
          
          echo "‚úÖ Sistema saud√°vel: $BODY"

      - name: Testar Autentica√ß√£o
        run: |
          PROD_URL="${{ env.PRODUCTION_URL }}"
          
          # Tenta acessar endpoint protegido sem auth (deve retornar 401 ou erro)
          HTTP_CODE=$(curl -s -w "%{http_code}" -o /dev/null $PROD_URL/api/trpc/auth.me || echo "000")
          
          echo "Auth endpoint retornou: HTTP $HTTP_CODE"
          
          # Aceitar 401 (n√£o autorizado) ou 200 (sem usu√°rio) como respostas v√°lidas
          if [ "$HTTP_CODE" == "401" ] || [ "$HTTP_CODE" == "200" ]; then
            echo "‚úÖ Autentica√ß√£o funcionando corretamente"
          else
            echo "‚ö†Ô∏è Endpoint de autentica√ß√£o retornou c√≥digo inesperado: $HTTP_CODE"
          fi

      - name: Testar Rate Limiting
        run: |
          PROD_URL="${{ env.PRODUCTION_URL }}"
          
          echo "Testando rate limiting com m√∫ltiplas requisi√ß√µes..."
          
          # Faz 12 requisi√ß√µes r√°pidas (limite √© 10)
          for i in {1..12}; do
            curl -s $PROD_URL/api/trpc/health.check > /dev/null
            sleep 0.1
          done
          
          # A pr√≥xima pode ser bloqueada
          HTTP_CODE=$(curl -s -w "%{http_code}" -o /dev/null $PROD_URL/api/trpc/health.check || echo "000")
          
          if [ "$HTTP_CODE" == "429" ]; then
            echo "‚úÖ Rate limiting ativo e funcionando"
          elif [ "$HTTP_CODE" == "200" ]; then
            echo "‚ö†Ô∏è Rate limiting pode estar configurado mas n√£o bloqueou (HTTP 200)"
          else
            echo "‚ö†Ô∏è Rate limiting resposta: HTTP $HTTP_CODE"
          fi

      - name: Verificar tempo de resposta
        run: |
          PROD_URL="${{ env.PRODUCTION_URL }}"
          
          START_TIME=$(date +%s%3N)
          HTTP_CODE=$(curl -s -w "%{http_code}" -o /dev/null $PROD_URL/api/trpc/health.check)
          END_TIME=$(date +%s%3N)
          
          RESPONSE_TIME=$((END_TIME - START_TIME))
          
          echo "Tempo de resposta: ${RESPONSE_TIME}ms"
          
          if [ $RESPONSE_TIME -lt 2000 ]; then
            echo "‚úÖ Tempo de resposta adequado (<2s)"
          else
            echo "‚ö†Ô∏è Tempo de resposta alto: ${RESPONSE_TIME}ms"
          fi

      - name: Notificar falha via Issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date().toISOString();
            
            // Buscar issues abertas com label 'health-check-alert'
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-check-alert'
            });
            
            if (existingIssues.length > 0) {
              // Adicionar coment√°rio √† issue existente
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues[0].number,
                body: `üö® **ALERTA ADICIONAL DE PRODU√á√ÉO**\n\nO sistema falhou no health check √†s ${now}\n\nVerifique: https://railway.app/dashboard\n\nWorkflow: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
              });
            } else {
              // Criar nova issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üö® ALERTA: Sistema em Produ√ß√£o Fora do Ar',
                body: `üö® **ALERTA DE PRODU√á√ÉO**\n\nO sistema falhou no health check √†s ${now}\n\n**O que verificar:**\n- Railway Dashboard: https://railway.app/dashboard\n- Logs da aplica√ß√£o\n- Conex√£o com banco de dados\n- Vari√°veis de ambiente\n\n**Workflow:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\nEsta issue ser√° fechada automaticamente quando o sistema voltar.`,
                labels: ['health-check-alert', 'urgent']
              });
            }

      - name: Fechar issues de alerta se sucesso
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-check-alert'
            });
            
            for (const issue of existingIssues) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `‚úÖ **Sistema Recuperado**\n\nO health check passou com sucesso √†s ${new Date().toISOString()}\n\nO sistema est√° operacional novamente.`
              });
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }
